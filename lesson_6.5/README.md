# Домашнее задание к занятию 6. «Troubleshooting»

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

### Ответ:
---

1. Найти `opid` операций, которые выполняются дольше 3 минут

```js  
db.currentOp(
   {
     "active" : true,
     "secs_running" : { "$gt" : 180 },
   }
)
```
2. Завершить операцию по `opid`

```js
db.killOp(<opid>)
```

- Настроить профилирование и проанализировать долгие запросы. Далее можно оптимизировать запросы или настроить индексы
- Как вариант - настроить максимально возможное время выполнения запросов через `$maxTimeMS`. 

---

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

### Ответ:
---

Предполагаю, проблема в методе удаления ключей с истекшим сроком действия. По умолчанию `Redis` запускает 20 `ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP` 10 раз в секунду. То есть алгоритм удаляет 200 ключей в секунду. 
Если `Redis` блокирует операции записи, значит в базе появилось большое количество ключей, которые истекают в одно время (их количество больше 25% от текущей совокупности ключей с истекшим сроком действия). 


---
 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

### Ответ:
---

Вероятные причины:
1. Сетевые проблемы. Необходимо проверить подключение. Также необходимо выполнить команду `SHOW GLOBAL STATUS LIKE 'Aborted_connects'`. Если его значение увеличивается (оно увеличивается при каждом прерыванни соединения со стороны сервера), то необходимо увеличить параметр `connect_timeout` 
2. Большой запрос, который не успевает отработать за `net_read_timeout` (30 секунд по умолчанию). Увеличить данный параметр
3. Если в ошибке есть `ER_NET_PACKET_TOO_LARGE`, то вероятно проблема в превышении размера сообщения. Необходимо увеличить параметр `max_allowed_packet`

---

## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?

### Ответ:
---

`OOM Killer` - процесс, который завершает приложение при нехватки памяти. Полагаю, что на сервере `PostgreSQL` утилизировал всю доступную память, поэтому `oom-killer` завершил его процесс. Это необходимо, чтобы не обрушилась вся система.

Какие есть пути решения:
1. Отключить `oom-killer`. Это небезопасно для сервера, поэтому не рекомендуется
2. Ограничить доступную для `PostgreSQL` память (shared_buffers+ ( temp_buffers+ work_mem) *max_connections)
3. Не запускать на одном сервере с `PostgreSQL` другие приложения, которые могут утилизировать RAM
4. Увеличить ресурсы сервера

---
